# 心理咨询系统项目分析报告

## 📋 项目概览

这是一个基于大语言模型（LLM）的**智能心理咨询系统**，采用模块化架构设计，集成了**RAG（检索增强生成）**和**三层记忆系统**，用于提供个性化、专业的心理咨询服务。

### 核心特性

✅ **多LLM后端支持**：OpenAI API、Anthropic、本地GGUF模型  
✅ **RAG知识增强**：心理知识库 + 用户档案库  
✅ **三层记忆架构**：短期会话 + 中期用户档案 + 长期趋势追踪  
✅ **完整评估体系**：21个评估指标，多数据集支持  
✅ **对比实验框架**：裸LLM vs LLM+RAG vs 完整系统  

---

## 🏗️ 系统架构

### 四层架构设计

```
应用层 (examples/, tests/)
    ↓
业务逻辑层 (dialogue/)
    ↓
核心模块层 (llm/, knowledge/, memory/)
    ↓
基础设施层 (数据库、API、存储)
```

### 核心模块详解

#### 1. **LLM模块** (`llm/`)
- **设计模式**：策略模式 + 工厂模式
- **功能**：提供统一的大语言模型接口
- **支持后端**：
  - OpenAI API (GPT-4, GPT-3.5等)
  - Anthropic (Claude)
  - 本地GGUF模型 (llama.cpp)
- **核心类**：
  - `BaseLLM` - 抽象基类
  - `OpenAILLM` - OpenAI实现
  - `LocalLLM` - 本地模型实现
  - `LLMFactory` - 工厂类

#### 2. **知识库模块** (`knowledge/`)
- **设计模式**：策略模式 + 组合模式
- **功能**：管理心理知识库，提供RAG检索
- **双知识库架构**：
  - **心理知识库**：专业心理学知识（CBT、焦虑、抑郁、失眠等）
  - **用户知识库**：个人档案、历史记录
- **核心类**：
  - `BaseKnowledgeBase` - 抽象基类
  - `ChromaKnowledgeBase` - 基于ChromaDB实现
  - `RAGManager` - 统一检索管理

#### 3. **记忆系统模块** (`memory/`)
- **设计模式**：分层架构 + 存储库模式
- **功能**：实现三层记忆，追踪用户状态
- **三层记忆架构**：
  - **SessionMemory**（会话级-短期）：当前对话的所有轮次
  - **UserProfile**（用户档案-中期）：基本信息、主要问题、生活事件
  - **LongTermTrends**（长期趋势）：情绪历史、话题历史、干预历史
- **核心类**：
  - `MemoryManager` - 记忆管理器
  - `UserMemory` - 用户记忆模型
  - `JSONMemoryStorage` - JSON存储实现

#### 4. **对话管理模块** (`dialogue/`)
- **设计模式**：门面模式 + 模板方法模式
- **功能**：整合所有组件，提供完整对话功能
- **核心流程**：
  1. 构建上下文（记忆检索 + RAG检索）
  2. 构建Prompt（系统消息 + 历史 + 当前输入）
  3. LLM生成回复
  4. 更新记忆系统

---

## 📊 完整对话流程

```
用户输入: "我最近压力很大"
    ↓
DialogueManager.chat(user_id, session_id, message, emotion)
    ↓
┌────────────────────────────────┐
│ 步骤1: 构建上下文               │
│  - 记忆检索：用户档案、历史会话  │
│  - RAG检索：心理知识、用户信息   │
└────────────────────────────────┘
    ↓
┌────────────────────────────────┐
│ 步骤2: 构建Prompt              │
│  - 系统消息（含记忆 + RAG）     │
│  - 对话历史                    │
│  - 当前输入                    │
└────────────────────────────────┘
    ↓
┌────────────────────────────────┐
│ 步骤3: LLM生成                 │
│  - 调用语言模型生成回复         │
└────────────────────────────────┘
    ↓
┌────────────────────────────────┐
│ 步骤4: 更新记忆                │
│  - 保存对话轮次                │
│  - 更新情绪轨迹                │
│  - 更新长期趋势                │
└────────────────────────────────┘
    ↓
返回: "我理解你的感受，压力大是很常见的..."
```

---

## 📁 项目文件结构

```
psychological_counseling_system/
├── configs/                    # 配置文件
│   └── config.yaml            # 系统主配置
│
├── llm/                       # LLM模块
│   ├── __init__.py
│   ├── base.py               # 抽象基类
│   ├── factory.py            # 工厂类
│   ├── openai_llm.py         # OpenAI实现
│   └── local_llm.py          # 本地模型实现
│
├── knowledge/                 # 知识库模块
│   ├── __init__.py
│   ├── base.py               # 抽象基类
│   ├── chroma_kb.py          # ChromaDB实现
│   └── rag_manager.py        # RAG管理器
│
├── memory/                    # 记忆系统模块
│   ├── __init__.py
│   ├── models.py             # 数据模型
│   ├── storage.py            # 存储实现
│   └── manager.py            # 记忆管理器
│
├── dialogue/                  # 对话管理模块
│   ├── __init__.py
│   └── manager.py            # 对话管理器
│
├── evaluation/                # 评估模块
│   ├── README.md             # 评估文档（16KB）
│   ├── framework.py          # 评估框架
│   ├── configs/              # 评估配置
│   │   ├── default_config.yaml
│   │   ├── quick_test_config.yaml
│   │   └── full_eval_config.yaml
│   ├── datasets/             # 数据集管理
│   │   ├── dataset_loader.py
│   │   ├── mentalchat_loader.py
│   │   ├── memory_test_generator.py
│   │   └── download_datasets.py  # 数据集下载脚本
│   ├── metrics/              # 评估指标
│   │   ├── technical_metrics.py   # 技术指标
│   │   ├── clinical_metrics.py    # 临床指标
│   │   ├── safety_metrics.py      # 安全指标
│   │   ├── memory_metrics.py      # 记忆指标
│   │   └── rag_metrics.py         # RAG指标
│   ├── evaluators/           # 评估器
│   │   ├── system_evaluator.py
│   │   └── comparison_evaluator.py
│   ├── scripts/              # 运行脚本
│   │   └── run_quick_test.py
│   └── results/              # 评估结果（自动生成）
│
├── examples/                  # 使用示例
│   ├── basic_rag_chat.py     # 基础RAG对话
│   ├── multi_session_chat.py # 多会话对话
│   ├── add_knowledge.py      # 添加知识库
│   ├── comparison_experiment.py  # 对比实验
│   ├── evaluation_examples.py    # 评估示例
│   └── visualize_results.py      # 结果可视化
│
├── experiments/               # 实验数据（自动生成）
│   ├── comparison_report_*.json
│   ├── detailed_comparison.md
│   ├── response_examples.md
│   └── figures/              # 生成的图表
│       ├── response_time_comparison.png
│       ├── response_length_comparison.png
│       └── scenario_comparison.png
│
├── data/                      # 数据目录
│   ├── sample_knowledge/     # 示例知识库
│   │   ├── cbt_therapy.txt   # 认知行为疗法
│   │   ├── anxiety_management.txt
│   │   ├── depression_treatment.txt
│   │   └── sleep_insomnia.txt
│   ├── sample_user_info/     # 示例用户档案
│   │   ├── user_a_profile.txt
│   │   └── user_b_profile.txt
│   └── mentalchat/           # MentalChat16K数据集
│
├── models/                    # 本地模型目录
│   └── README.md
│
├── tests/                     # 测试文件
│   └── test_system.py
│
├── utils/                     # 工具函数
│   └── helpers.py
│
├── docs/                      # 文档
│   ├── architecture.md       # 架构设计文档
│   └── quickstart.md         # 快速开始指南
│
├── requirements.txt           # Python依赖
├── README.md                  # 项目说明
├── INSTALLATION.md           # 安装指南
├── EXPERIMENT_GUIDE.md       # 实验指南
├── UPDATE_SUMMARY.md         # 更新总结
├── PHASE1_SUMMARY.md         # 第一阶段总结
├── run_full_experiment.sh    # Linux/Mac运行脚本
└── run_full_experiment.bat   # Windows运行脚本
```

---

## 🎯 核心功能

### 1. RAG知识增强

**心理知识库**（11,000+字）：
- 认知行为疗法（CBT）详解
- 焦虑症管理技术
- 抑郁症治疗方法
- 失眠认知行为疗法

**用户知识库**：
- 个人基本信息
- 历史对话记录
- 问题类型和严重程度

**检索流程**：
1. 将用户查询转换为向量
2. 在两个知识库中并行检索
3. 重排序（可选）
4. 构建组合上下文

### 2. 三层记忆系统

**短期记忆（SessionMemory）**：
- 当前会话的所有对话轮次
- 即时上下文追踪
- 会话结束后归档

**中期记忆（UserProfile）**：
- 用户基本信息
- 主要心理问题
- 重要生活事件
- 治疗目标

**长期记忆（LongTermTrends）**：
- 情绪历史轨迹
- 话题变化趋势
- 干预效果记录
- 跨会话模式识别

### 3. 完整评估体系

**21个评估指标**分为5类：

#### 技术指标（5个）
- BERT Score (Precision, Recall, F1)
- ROUGE (ROUGE-1, ROUGE-2, ROUGE-L)
- BLEU
- 响应时间
- 响应长度

#### 临床指标（7个）
- Empathy（共情）
- Support（支持）
- Guidance（指导）
- Relevance（相关性）
- Communication（沟通）
- Fluency（流畅性）
- Safety（安全性）

#### 记忆指标（4个）
- 短期记忆召回
- 工作记忆准确率
- 长期记忆一致性
- 整体准确率

#### RAG指标（3个）
- Recall（召回率）
- Precision（精确率）
- F1 Score

#### 安全性指标（2个）
- 有害内容检测
- 隐私保护

### 4. 对比实验框架

**三种配置对比**：
1. **裸LLM**（基线）：只使用语言模型
2. **LLM + RAG**：语言模型 + 知识库检索
3. **完整系统**：语言模型 + RAG + 三层记忆

**自动化流程**：
- 相同测试数据集
- 统一评估指标
- 统计显著性检验
- 可视化对比图表

---

## 📚 支持的数据集

### 1. MentalChat16K（主要数据集）
- **规模**：16,113个心理咨询对话
- **测试集**：200个预定义测试问题
- **来源**：HuggingFace
- **用途**：主要训练和评估数据

### 2. Empathetic Dialogues
- **规模**：25,000个对话
- **情绪类型**：32种情绪标注
- **用途**：共情能力评估

### 3. Counsel Chat
- **规模**：3,000个专业咨询对话
- **特点**：真实咨询师回复
- **用途**：专业性评估

### 4. 自建记忆测试集
- **规模**：50个记忆测试场景
- **类型**：短期、中期、长期记忆测试
- **用途**：记忆系统评估

---

## 🚀 快速开始

### 步骤1: 环境配置

```bash
# 克隆仓库（或解压）
cd psychological_counseling_system

# 安装依赖
pip install -r requirements.txt

# 配置API密钥（如使用OpenAI）
export OPENAI_API_KEY="your-api-key"
```

### 步骤2: 添加知识库

```bash
# 添加心理知识到系统
python examples/add_knowledge.py
```

### 步骤3: 运行基础对话

```bash
# 基础RAG对话示例
python examples/basic_rag_chat.py
```

### 步骤4: 运行快速评估

```bash
# 5分钟快速测试
python evaluation/scripts/run_quick_test.py
```

### 步骤5: 运行完整实验

```bash
# Linux/Mac
./run_full_experiment.sh

# Windows
run_full_experiment.bat
```

---

## 🔬 实验功能

### 对比实验

**运行脚本**：
```bash
python examples/comparison_experiment.py
```

**输出内容**：
- 三种配置的性能对比
- 详细的指标分析
- 响应时间对比
- 响应质量对比

**生成文件**：
```
experiments/
├── comparison_report_20251109_000230.json  # 完整数据
├── detailed_comparison.md                   # 对比表格
├── response_examples.md                     # 响应案例
└── figures/
    ├── response_time_comparison.png         # 时间对比图
    ├── response_length_comparison.png       # 长度对比图
    └── scenario_comparison.png              # 场景对比图
```

### 可视化结果

**运行脚本**：
```bash
python examples/visualize_results.py
```

**生成图表**：
- 雷达图：多维指标对比
- 柱状图：分类指标对比
- 折线图：趋势分析
- 热力图：相关性分析

---

## 💡 设计理念

### 1. 高度模块化
- 每个模块职责单一
- 易于理解和维护
- 支持独立开发和测试

### 2. 松耦合
- 模块间通过接口通信
- 降低依赖关系
- 便于替换和扩展

### 3. 配置驱动
- 所有行为通过配置文件控制
- 无需修改代码即可调整
- 支持多种部署场景

### 4. 易于扩展
- 抽象基类 + 工厂模式
- 新功能无需修改现有代码
- 支持插件式开发

### 5. 完全增量
- 所有新功能都是增量添加
- 不破坏原有结构
- 完全向后兼容

---

## 📈 技术栈

### 核心技术
- **Python 3.8+**
- **LLM后端**：OpenAI API, Anthropic, llama.cpp
- **向量数据库**：ChromaDB, FAISS
- **Embedding模型**：Sentence Transformers
- **配置管理**：PyYAML, Pydantic

### 数据处理
- **NumPy**: 数值计算
- **Pandas**: 数据处理
- **Matplotlib**: 可视化

### NLP工具
- **LangChain**: LLM应用框架
- **tiktoken**: Token计数
- **HuggingFace**: 模型和数据集

### 评估工具
- **BERT Score**: 语义相似度
- **ROUGE**: 摘要评估
- **BLEU**: 翻译质量

---

## ⚙️ 配置说明

### 系统主配置 (`configs/config.yaml`)

```yaml
# LLM配置
llm:
  backend: 'api'  # 'api' 或 'local'
  api:
    provider: 'openai'
    model: 'gpt-4o-mini'
    temperature: 0.7
    max_tokens: 2000
  local:
    model_path: 'models/your-model.gguf'
    n_ctx: 4096
    n_gpu_layers: 35

# RAG配置
rag:
  embedding:
    model_name: 'sentence-transformers/all-MiniLM-L6-v2'
  vector_store:
    type: 'chroma'
    persist_directory: 'data/chroma_db'
  retrieval:
    top_k: 5
    similarity_threshold: 0.7

# 记忆配置
memory:
  storage:
    type: 'json'
    storage_dir: 'data/memory'
  layers:
    session: true
    user_profile: true
    long_term: true
  retrieval:
    max_history_sessions: 5
    decay_factor: 0.8

# 对话配置
dialogue:
  system_prompt: "你是一个专业的心理咨询助手..."
  max_context_length: 4000
  generation:
    temperature: 0.7
    max_tokens: 2000
```

### 评估配置 (`evaluation/configs/*.yaml`)

三种配置文件：
- `quick_test_config.yaml` - 快速测试（10样本，5分钟）
- `default_config.yaml` - 标准评估（200样本）
- `full_eval_config.yaml` - 完整评估（论文级）

---

## 🎓 适用场景

### 学术研究
- ✅ 心理学AI应用研究
- ✅ RAG技术研究
- ✅ 记忆系统研究
- ✅ 对话系统评估

### 毕业论文
- ✅ 完整的系统实现
- ✅ 详细的评估数据
- ✅ 可视化图表
- ✅ 对比实验结果

### 产品原型
- ✅ 模块化架构便于迭代
- ✅ 多LLM后端支持
- ✅ 完整的评估体系
- ✅ 可扩展的设计

### 教学示例
- ✅ 清晰的代码结构
- ✅ 详细的文档
- ✅ 丰富的示例
- ✅ 完整的测试

---

## 📊 性能指标（示例）

### 快速测试结果（10个样本）

**技术指标**：
- BERT Score F1: 0.872
- BERT Precision: 0.869
- BERT Recall: 0.875
- ROUGE-1: 0.345
- ROUGE-L: 0.312
- 平均响应时间: 1.23秒
- 平均响应长度: 256字符

**专业质量**（满分5分）：
- Empathy（共情）: 4.30
- Support（支持）: 4.10
- Guidance（指导）: 4.20
- Relevance（相关性）: 4.40
- Communication（沟通）: 4.30
- Fluency（流畅性）: 4.50
- Safety（安全性）: 4.60

**记忆系统**：
- 短期记忆召回: 92.00%
- 整体准确率: 88.00%

**RAG效果**：
- 检索召回率: 87.00%
- 检索精确率: 73.00%

---

## 🔒 安全性考虑

### 数据隐私
- 用户数据本地存储
- 支持加密存储
- 敏感信息脱敏

### 输入验证
- 消息长度限制
- 注入攻击检测
- 异常输入过滤

### 内容安全
- 有害内容检测
- 自杀风险识别
- 伦理边界保护

---

## 🚧 已知限制

1. **语言支持**：目前主要支持中文
2. **本地模型**：需要GPU才能达到最佳性能
3. **评估速度**：LLM评分较慢（可禁用）
4. **数据集**：Counsel Chat需手动下载

---

## 🔮 未来扩展方向

### 短期（1-2个月）
- [ ] 增加更多LLM后端支持
- [ ] 优化记忆检索算法
- [ ] 增加更多评估指标
- [ ] Web界面开发

### 中期（3-6个月）
- [ ] 多语言支持
- [ ] 语音对话功能
- [ ] 移动端应用
- [ ] 云端部署方案

### 长期（6个月以上）
- [ ] 强化学习优化
- [ ] 个性化模型微调
- [ ] 专家系统集成
- [ ] 临床试验

---

## 📝 总结

这是一个**功能完整、设计优秀、文档详尽**的心理咨询系统项目，具有以下突出特点：

### 技术优势
✅ **模块化架构**：高内聚、低耦合  
✅ **RAG增强**：专业知识库 + 检索优化  
✅ **三层记忆**：短中长期记忆完整实现  
✅ **多后端支持**：API和本地模型灵活切换  
✅ **完整评估**：21个指标，多数据集  

### 使用优势
✅ **配置驱动**：无需改代码即可调整  
✅ **增量开发**：不破坏原有结构  
✅ **丰富示例**：覆盖各种使用场景  
✅ **详细文档**：20,000+字文档说明  
✅ **一键运行**：自动化实验脚本  

### 研究价值
✅ **创新性**：三层记忆系统（Mentalic Net没有）  
✅ **完整性**：从数据到评估的完整流程  
✅ **可重现**：详细的实验配置和结果  
✅ **可扩展**：易于添加新功能和模块  

---

## 📞 使用建议

### 对于初学者
1. 先阅读 `docs/quickstart.md`
2. 运行 `examples/basic_rag_chat.py`
3. 运行 `evaluation/scripts/run_quick_test.py`
4. 查看生成的结果文件

### 对于开发者
1. 阅读 `docs/architecture.md` 了解架构
2. 查看 `examples/` 目录的各种示例
3. 修改 `configs/config.yaml` 定制配置
4. 扩展自己的模块

### 对于研究者
1. 使用 `full_eval_config.yaml` 完整评估
2. 运行 `comparison_experiment.py` 对比实验
3. 使用 `visualize_results.py` 生成图表
4. 将结果用于论文撰写

---

**项目状态**：✅ 第一阶段完成  
**代码行数**：2900+ 行  
**文档字数**：20,000+ 字  
**文件数量**：60+ 个  
**评估指标**：21 个  
**数据集支持**：4 个  

🎉 **这是一个完整、专业、可用的心理咨询系统项目！**
